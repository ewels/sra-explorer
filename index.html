<!DOCTYPE html>
<html lang="en" ng-app="sraExplorerApp">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="An experimental interface for exploring the Sequence Read Archive">
    <meta name="author" content="Phil Ewels">

    <title>SRA Explorer</title>

    <!-- Framework CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

    <!-- SRA-explorer styles -->
    <style type="text/css">

        /* Core structural setup */
        body {
          padding-top: 50px;
        }

        /* Styles for little clear button on search fields */
        .form-control-clear, .form-control-clear:hover, .form-control-clear:focus, .form-control-clear:active {
          pointer-events: auto;
          text-decoration: none;
          cursor: pointer;
          color: #999;
          z-index: 4;
        }
        .form-control-clear:hover, .form-control-clear:focus, .form-control-clear:active {
          color: #666;
        }

        /* Make button links have proper styling */
        a[ng-click]{
            cursor: pointer;
        }

        /* Page Header */
        .jumbotron {
          margin-top: 30px;
        }
        .jumbotron h1 {
          margin-top: 0;
        }
        .jumbotron h1 a {
          color: #333;
          text-decoration: none;
        }

        /* Saved datasets */
        #savedDatasets pre {
          overflow-x: auto;
        }
        #savedDatasets pre code {
          font-size: 10px;
          white-space: pre;
        }

        /* Seqera Platform stuff */
        #fullSeqeraPlatform_table_wrapper {
          overflow: auto;
          width: 100%;
          max-height: 300px;
        }

    </style>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body ng-controller="searchCtrl">

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container">
          <a class="navbar-brand" href="#" ng-click="returnToHomeButton()">SRA-Explorer</a>
          <a href="#" class="btn navbar-btn" style="float:right;" ng-class="savedResults.length == 0 ? 'disabled btn-default' : 'btn-primary'" ng-click="checkoutButton()"><span class="glyphicon glyphicon-shopping-cart"></span> <span ng-bind="savedResults.length"></span> saved datasets</a>
        </div>
    </div>

    <div class="container">

        <div class="jumbotron">
            <h1><a href="#" ng-click="returnToHomeButton()">SRA Explorer</a></h1>
            <p>This tool aims to make datasets within the Sequence Read Archive more accessible.</p>
            <form class="form-horizontal" role="search">
                <div class="form-group form-group-lg">
                    <label class="col-sm-2 control-label" for="searchText">Search for:</label>
                    <div class="col-sm-10">
                        <div class="input-group">
                            <div class="has-feedback has-clear">
                                <input ng-model="searchText" id="searchText" type="text" class="form-control" placeholder="Enter accession number" required>
                                <a class="glyphicon glyphicon-remove-sign form-control-feedback form-control-clear" ng-click="searchText = ''" ng-show="searchText.length"></a>
                            </div>
                            <div class="input-group-btn">
                                <button ng_click="search()" class="btn btn-default btn-lg" type="submit"><span class="glyphicon glyphicon-search"></span></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2 control-label" for="maxResults">Max Results</label>
                    <div class="col-sm-2">
                        <input type="number" max="500" class="form-control" id="maxResults" ng-model="maxResults" value="100" required>
                    </div>

                    <label class="col-sm-2 control-label" for="retstart">Start At Record</label>
                    <div class="col-sm-2">
                        <input type="number" class="form-control" id="retstart" ng-model="retstart" value="0" required>
                    </div>
                </div>
                <span id="helpBlock" class="help-block">
                    Need inspiration? Try
                    <code ng-click="searchText='GSE30567'; search()" style="cursor:pointer;">GSE30567</code>,
                    <code ng-click="searchText='SRP043510'; search()" style="cursor:pointer;">SRP043510</code>,
                    <code ng-click="searchText='PRJEB8073'; search()" style="cursor:pointer;">PRJEB8073</code>,
                    <code ng-click="searchText='ERP009109'; search()" style="cursor:pointer;">ERP009109</code> or
                    <code ng-click="searchText='human liver miRNA'; search()" style="cursor:pointer;">human liver miRNA</code>.
                </span>
            </form>
        </div>

        <div class="alert alert-info" ng-show="savedResults.length > 0 && results.length == 0 && !showSaved">
          You have {{ savedResults.length }} datasets in your collection.
          <a href="#" ng-click="checkoutButton()">View saved datasets</a>.
        </div>

        <p ng-show="loadingSpinner" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading..</p>

        <div ng-show="results.length > 0">
            <hr>

            <div class="alert alert-info">
              Select relevant datasets and click <em>add to collection</em>.
              When you're finished, view all saved datasets with the button in the top right of the
              page, where you can copy the SRA URLs.
            </div>

            <p>Showing <span ng-bind="filteredResults.length" class="badge"></span> results.</p>

            <button class="pull-right btn btn-primary" ng-class="{disabled: selectedItems == 0}" ng-click="saveDatasets()">Add <span ng-bind="selectedItems">0</span> to collection</button>

            <form class="form-inline" role="search">
              <div class="form-group">
                <label for="filterText">Filter results:</label>
                    <div class="input-group">
                        <div class="form-group has-feedback has-clear">
                            <input ng-model="filterText" id="filterText" type="text" class="form-control" placeholder="Enter search term">
                            <a class="glyphicon glyphicon-remove-sign form-control-feedback form-control-clear" ng-click="filterText = ''" ng-show="filterText.length"></a>
                        </div>
                        <div class="input-group-btn">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">All Fields <span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right">
                      <li class="active"><a href="#">All Fields</a></li>
                      <li><a href="#">Title</a></li>
                      <li><a href="#">Accession</a></li>
                      <li><a href="#">Instrument</a></li>
                    </ul>
                  </div>
                    </div>
              </div>
            </form>

            <hr>

            <div class="table-responsive"><table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th><input type="checkbox" ng-model="selectAll" ng-click="checkAll()"></th>
                        <th><a ng-click="sortType = 'title'; sortReverse = !sortReverse">
                                Title
                                <span ng-show="sortType == 'title' && !sortReverse" class="fa fa-caret-down"></span>
                        <span ng-show="sortType == 'title' && sortReverse" class="fa fa-caret-up"></span>
                        </a></th>
                        <th><a ng-click="sortType = 'accession'; sortReverse = !sortReverse">
                                Accession
                                <span ng-show="sortType == 'accession' && !sortReverse" class="fa fa-caret-down"></span>
                        <span ng-show="sortType == 'accession' && sortReverse" class="fa fa-caret-up"></span>
                        </a></th>
                        <th><a ng-click="sortType = 'platform'; sortReverse = !sortReverse">
                                Instrument
                                <span ng-show="sortType == 'platform' && !sortReverse" class="fa fa-caret-down"></span>
                        <span ng-show="sortType == 'platform' && sortReverse" class="fa fa-caret-up"></span>
                        </a></th>
                        <th><a ng-click="sortType = 'total_bases'; sortReverse = !sortReverse">
                                Total Bases (Mb)
                                <span ng-show="sortType == 'total_bases' && !sortReverse" class="fa fa-caret-down"></span>
                        <span ng-show="sortType == 'total_bases' && sortReverse" class="fa fa-caret-up"></span>
                        </a></th>
                        <th><a ng-click="sortType = 'createdate'; sortReverse = !sortReverse">
                                Date Created
                                <span ng-show="sortType == 'createdate' && !sortReverse" class="fa fa-caret-down"></span>
                        <span ng-show="sortType == 'createdate' && sortReverse" class="fa fa-caret-up"></span>
                        </a></th>
                    </tr>
                </thead>
                <tbody>
                  <tr ng-repeat="x in results | orderBy:sortType:sortReverse | filter:filterText as filteredResults" ng-click="rowClicked(x)" ng-class="{ success: x.selected }">
                        <td><input type="checkbox" ng-checked="x.selected" ng-click="toggleRow($event, x)"></td>
                    <td>{{ x.title }}</td>
                    <td><a href="https://www.ncbi.nlm.nih.gov/sra/?term={{ x.accession }}" target="_blank">{{ x.accession }}</a></td>
                    <td>{{ x.platform }}</td>
                    <td>{{ x.total_bases }}</td>
                    <td>{{ x.createdate | date:'dd MMM yyyy' }}</td>
                  </tr>
                </tbody>
            </table></div>
        </div>

        <!-- Saved datasets -->
        <div id="savedDatasets" ng-show="showSaved" class="animate-show">
            <h2>
              <span ng-bind="savedResults.length"></span> Saved Datasets
              <button ng-show="savedResults.length > 0" ng-click="returnSaved()" class="btn btn-default" style="float:right;">Remove all from collection and send to search results</button>
            </h2>

            <div>
              <!-- Nav tabs -->
              <ul class="nav nav-tabs" role="tablist">
                <li class="active"><a href="#fastq_tabcontent" aria-controls="fastq_tabcontent" role="tab" data-toggle="tab">FastQ Downloads</a></li>
                <li><a href="#sra_tabcontent" aria-controls="sra_tabcontent" role="tab" data-toggle="tab">SRA Downloads</a></li>
                <li><a href="#full_metadata_tabcontent" aria-controls="full_metadata_tabcontent" role="tab" data-toggle="tab">Full Metadata</a></li>
                <li><a href="#seqera_platform_tabcontent" aria-controls="seqera_platform_tabcontent" role="tab" data-toggle="tab">Seqera Platform</a></li>
              </ul>

              <div class="tab-content">
                <div role="tabpanel" class="tab-pane fade in active" id="fastq_tabcontent">
                  <div ng-show="savedResults.length > 0" class="panel-group" id="fastqAccordion" role="tablist" aria-multiselectable="true">
                    <p><br>To download FastQ files directly, sra-explorer queries the <a href="https://www.ebi.ac.uk/ena" target="_blank" rel="nofollow">ENA</a> for each SRA run accession number.</p>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fastqAccordion" href="#fastqURLs">Raw FastQ Download URLs</a>
                        </h4>
                      </div>
                      <div id="fastqURLs" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>The following is a list of links to download the selected SRA runs as FastQ from the ENA.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fastqURLs_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fastqURLs_content', 'sra_explorer_fastq_urls.txt')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fastqURLs_content"><code ng-repeat="x in savedResultsENAfastq">{{ x.fastq_url }}{{ nlChr }}</code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fastqAccordion" href="#fastqURLs_bashCURL">Bash script for downloading FastQ files</a>
                        </h4>
                      </div>
                      <div id="fastqURLs_bashCURL" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>This list of bash <code>curl</code> commands to download each SRA run FastQ file from the ENA, and save with a nicer filename, with the cleaned dataset title appended.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fastqURLs_bashCURL_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fastqURLs_bashCURL_content', 'sra_explorer_fastq_download.sh')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fastqURLs_bashCURL_content"><code>#!/usr/bin/env bash</code><code ng-repeat="x in savedResultsENAfastq">{{ nlChr }}curl -L {{ x.fastq_url }} -o {{ x.fastq_niceFilename }}</code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fastqAccordion" href="#fastqURLs_aspera">Aspera commands for downloading FastQ files</a>
                        </h4>
                      </div>
                      <div id="fastqURLs_aspera" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>This list of bash <code>ascp</code> commands to download each FastQ file from the ENA using the <a href="https://downloads.asperasoft.com/en/downloads/8?list" target="_blank" rel="nofollow">Aspera download tool</a>.</p>
                          <form class="form-horizontal">
                            <div class="form-group">
                              <label for="inputEmail3" class="col-sm-2 control-label">ascp openssh key path</label>
                              <div class="col-sm-10">
                                <div class="input-group">
                                  <input type="text" class="form-control" id="ascp_openssh_location" ng-model="ascp_openssh_location">
                                  <span class="input-group-btn">
                                    <button class="btn btn-default" type="button" ng-click="set_ascp_openssh_location('linux')"><i class="fa fa-linux" aria-hidden="true"></i> Linux</button>
                                    <button class="btn btn-default" type="button" ng-click="set_ascp_openssh_location('osx')"><i class="fa fa-apple" aria-hidden="true"></i> OSX</button>
                                  </span>
                                </div>
                              </div>
                            </div>
                            <div class="form-group">
                              <label for="inputEmail3" class="col-sm-2 control-label">Rename files?</label>
                              <div class="col-sm-10">
                                <label class="radio-inline">
                                  <input type="radio" ng-model="ascp_append_mv" ng-value="true"> Append <code>mv</code> command to rename downloaded files
                                </label>
                                <label class="radio-inline">
                                  <input type="radio" ng-model="ascp_append_mv" ng-value="false"> Don't rename files
                                </label>
                              </div>
                            </div>
                          </form>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fastqURLs_aspera_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fastqURLs_aspera_content', 'sra_explorer_fastq_aspera_download.sh')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fastqURLs_aspera_content"><code>#!/usr/bin/env bash</code><code ng-repeat="x in savedResultsENAfastq">{{ nlChr }}ascp -QT -l 300m -P33001 -i {{ ascp_openssh_location }} {{ x.fastq_asperaurl }} .<span ng-show="ascp_append_mv"> && mv {{ x.fastq_filename }} {{ x.fastq_niceFilename }}</span></code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fastqAccordion" href="#fastqURLs_niceNames">Cluster Flow FastQ download file (nice filenames)</a>
                        </h4>
                      </div>
                      <div id="fastqURLs_niceNames" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>This list of URLs is followed by a nicer filename, with the cleaned dataset title appended. This is suitable for use with the <a href="http://clusterflow.io" target="_blank">Cluster Flow</a> <code>--file_list</code> download option.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fastqURLs_niceNames_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fastqURLs_niceNames_content', 'sra_explorer_fastq_nicenames.txt')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fastqURLs_niceNames_content"><code ng-repeat="x in savedResultsENAfastq">{{ x.fastq_url }}{{ tabChr }}{{ x.fastq_niceFilename }}{{ nlChr }}</code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fastqAccordion" href="#fastqURLs_bcbio">bcbio project file for FastQ downloads (nice filenames)</a>
                        </h4>
                      </div>
                      <div id="fastqURLs_bcbio" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>This list of URLs is followed by a nicer filename. This is suitable for use with <a href="https://bcbio-nextgen.readthedocs.io/en/latest/" target="_blank">bcbio-nextgen</a> analysis pipelines.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fastqURLs_bcbio_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fastqURLs_bcbio_content', 'sra_explorer_bcbio.txt')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fastqURLs_bcbio_content"><code>samplename,description</code><code ng-repeat="x in savedResultsENAfastq">{{ nlChr }}{{ x.fastq_url }},{{ x.fastq_niceFilename }}</code></pre>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="sra_tabcontent">
                  <div ng-show="savedResults.length > 0" class="panel-group" id="sraAccordion" role="tablist" aria-multiselectable="true">
                    <p><br>These download links are automatically generated based on the URL schema of the NCBI SRA.</p>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#sraAccordion" href="#ftpURLs">Raw SRA Download URLs</a>
                        </h4>
                      </div>
                      <div id="ftpURLs" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>The following is a list of links to download the selected SRA files.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#ftpURLs_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#ftpURLs_content', 'sra_explorer_sra_urls.txt')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <pre id="ftpURLs_content"><code ng-repeat="x in savedResults">{{ x.sra_url }}{{ nlChr }}</code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab">
                            <h4 class="panel-title">
                                <a role="button" data-toggle="collapse" data-parent="#sraAccordion" href="#ftpURLs_bashCURL">
                                    Bash script for downloading SRA files (nice filenames)
                                </a>
                            </h4>
                        </div>
                        <div id="ftpURLs_bashCURL" class="panel-collapse collapse" role="tabpanel">
                            <div class="panel-body">
                                <p>This list of bash <code>curl</code> commands to download each SRA file and save with a nicer filename, with the cleaned dataset title appended.</p>
                                <p>
                                    <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#ftpURLs_bashCURL_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                                    <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#ftpURLs_bashCURL_content', 'sra_explorer_sra_download.sh')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                                </p>
                                <pre id="ftpURLs_bashCURL_content"><code>#!/usr/bin/env bash</code><code ng-repeat="x in savedResults">{{ nlChr }}curl -L {{ x.sra_url }} -o {{ x.sra_niceFilename }}</code></pre>
                            </div>
                        </div>
                    </div>

                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab">
                            <h4 class="panel-title">
                                <a role="button" data-toggle="collapse" data-parent="#sraAccordion" href="#ftpURLs_niceNames">
                                    Cluster Flow SRA download file (nice filename)
                                </a>
                            </h4>
                        </div>
                        <div id="ftpURLs_niceNames" class="panel-collapse collapse" role="tabpanel">
                            <div class="panel-body">
                                <p>This list of URLs is followed by a nicer filename, with the cleaned dataset title appended. This is suitable for use with the <a href="http://clusterflow.io" target="_blank">Cluster Flow</a> <code>--file_list</code> download option.</p>
                                <p>
                                    <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#ftpURLs_niceNames_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                                    <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#ftpURLs_niceNames_content', 'sra_explorer_sra_nicenames.txt')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                                </p>
                                <pre id="ftpURLs_niceNames_content"><code ng-repeat="x in savedResults">{{ x.sra_url }}{{ tabChr }}{{ x.sra_niceFilename }}{{ nlChr }}</code></pre>
                            </div>
                        </div>
                      </div>
                  </div>
                </div>
                <div role="tabpanel" class="tab-pane fade" id="full_metadata_tabcontent">

                  <div ng-show="savedResults.length > 0" class="panel-group" id="fullMetaAccordion" role="tablist" aria-multiselectable="true">

                    <p><br>These files contain the metadata used by SRA-Explorer for downstream use. Note that each SRA record is repeated for every ENA FastQ entry.</p>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fullMetaAccordion" href="#fullTSV">TSV</a>
                        </h4>
                      </div>
                      <div id="fullTSV" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>The following is a TSV (tab separated values) file with all metadata fields for the selected samples.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fullTSV_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fullTSV_content', 'sra_explorer_metadata.tsv')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fullTSV_content"><code>Accession{{ tabChr }}Title{{ tabChr }}Platform{{ tabChr }}Total bases{{ tabChr }}Create date{{ tabChr }}SRA URL{{ tabChr }}SRA filename{{ tabChr }}SRA nice filename{{ tabChr }}FastQ URL{{ tabChr }}FastQ Aspera URL{{ tabChr }}FastQ filename{{ tabChr }}FastQ nice filename</code><code ng-repeat="x in savedResultsENAfastq">{{ nlChr }}{{ x.accession }}{{ tabChr }}{{ x.title }}{{ tabChr }}{{ x.platform }}{{ tabChr }}{{ x.total_bases }}{{ tabChr }}{{ x.createdate }}{{ tabChr }}{{ x.sra_url }}{{ tabChr }}{{ x.accession }}.sra{{ tabChr }}{{ x.sra_niceFilename }}{{ tabChr }}{{ x.fastq_url }}{{ tabChr }}{{ x.fastq_asperaurl }}{{ tabChr }}{{ x.fastq_filename }}{{ tabChr }}{{ x.fastq_niceFilename }}</code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fullMetaAccordion" href="#fullJSON">JSON</a>
                        </h4>
                      </div>
                      <div id="fullJSON" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>The following is a JSON file with all metadata fields for the selected samples.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fullJSON_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fullJSON_content', 'sra_explorer_metadata.json')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fullJSON_content"><code>{{ savedResultsENAfastq | json }}</code></pre>
                        </div>
                      </div>
                    </div>

                    <div class="panel panel-default">
                      <div class="panel-heading" role="tab">
                        <h4 class="panel-title">
                          <a role="button" data-toggle="collapse" data-parent="#fullMetaAccordion" href="#fullYAML">YAML</a>
                        </h4>
                      </div>
                      <div id="fullYAML" class="panel-collapse collapse" role="tabpanel">
                        <div class="panel-body">
                          <p>The following is a YAML file with all metadata fields for the selected samples.</p>
                          <p>
                            <button class="btn btn-sm btn-default btn-copy" data-clipboard-target="#fullYAML_content"><span class="glyphicon glyphicon-copy"></span> Copy</button>
                            <button class="btn btn-sm btn-default btn-download" ng-click="download_contents('#fullYAML_content', 'sra_explorer_metadata.yaml')"><span class="glyphicon glyphicon-download-alt"></span> Download</button>
                          </p>
                          <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                          <pre ng-show="savedResultsENAfastq.length > 0" id="fullYAML_content"><code>{{ savedResultsENAfastqYAML }}</code></pre>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
                <div role="tabpanel" class="tab-pane fade" id="seqera_platform_tabcontent">

                  <p><br>These files contain the metadata used by SRA-Explorer for downstream use. Note that each SRA record is repeated for every ENA FastQ entry.</p>

                  <div class="panel panel-default">
                    <div class="panel-heading" role="tab">
                      <h4 class="panel-title">
                        <a role="button" href="#seqera_platform">Seqera Platform</a>
                      </h4>
                    </div>
                    <div id="seqera_platform">
                      <div class="panel-body">
                        <p>Send all metadata to Seqera Platform as a saved Dataset, which you can use as an input when launching pipelines.</p>
                        <form id="seqera_platform_form" class="form-horizontal">
                          <div class="form-group">
                            <div class="col-sm-2">
                              <label class="sr-only" for="sp_organisation">Organisation</label>
                              <select class="form-control" ng-model="seqeraplatform.selected_org" ng-change="update_seqera_org()"> id="sp_organisation">
                                <option ng-repeat="(orgId, orgName) in seqeraplatform.orgs" value="{{ orgId }}">{{ orgName }}</option>
                              </select>
                            </div>
                            <div class="col-sm-2">
                              <label class="sr-only" for="sp_workspace_id">Workspace</label>
                              <select class="form-control" ng-model="seqeraplatform.workspace_id" id="sp_workspace_id">
                                <option ng-repeat="(wsId, wsName) in seqeraplatform.workspaces[seqeraplatform.selected_org]" value="{{ wsId }}">{{ wsName }}</option>
                              </select>
                            </div>
                            <div class="col-sm-2">
                              <label class="sr-only" for="sp_name">Dataset name</label>
                              <input type="text" class="form-control" ng-model="seqeraplatform.name" id="sp_name" placeholder="Dataset name" required>
                            </div>
                            <div class="col-sm-3">
                              <label class="sr-only" for="sp_description">Dataset description</label>
                              <input type="text" class="form-control" ng-model="seqeraplatform.description" id="sp_description" placeholder="Dataset description">
                            </div>
                            <div class="col-sm-3">
                              <button type="submit" class="btn btn-default" data-toggle="modal" data-target="#seqeraPlatformConnectionModal">
                                <span class="glyphicon glyphicon-log-in"></span> Connect
                              </button>
                              <button type="submit" class="btn btn-default" disabled ng-click="save_seqeraplatform(seqeraplatform)" ng-disabled="!seqeraplatform.credentials_valid || seqeraplatform.workspace_id == ''">
                                <span class="glyphicon glyphicon-send"></span> Add Dataset
                              </button>
                            </div>
                          </div>
                        </form>
                        <div ng-show="seqeraplatform.messages.length > 0" class="alert" ng-class="{'alert-info': !seqeraplatform.hasError, 'alert-danger': seqeraplatform.hasError }">
                          <p ng-repeat="x in seqeraplatform.messages"><ng-bind-html ng-bind-html="x"></ng-bind-html></p>
                        </div>
                        <p ng-show="savedResultsENAaccessions.length < savedResults.length" class="text-center"><span class="glyphicon glyphicon-refresh fa-spin"></span> Loading <span class="badge"><span ng-bind="savedResultsENAaccessions.length"></span> / <span ng-bind="savedResults.length"></span></span>..</p>
                        <div id="fullSeqeraPlatform_table_wrapper">
                          <table ng-show="savedResultsENAfastq.length > 0" id="fullSeqeraPlatform_content" class="table table-bordered table-hover table-condensed">
                            <thead>
                              <tr>
                                <th>Accession</th>
                                <th>Title</th>
                                <th>Platform</th>
                                <th>Total bases</th>
                                <th>Create date</th>
                                <th>SRA URL</th>
                                <th>SRA filename</th>
                                <th>SRA nice filename</th>
                                <th>FastQ URL</th>
                                <th>FastQ Aspera URL</th>
                                <th>FastQ filename</th>
                                <th>FastQ nice filename</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr ng-repeat="x in savedResultsENAfastq">
                                <td>{{ x.accession }}</td>
                                <td>{{ x.title }}</td>
                                <td>{{ x.platform }}</td>
                                <td>{{ x.total_bases }}</td>
                                <td>{{ x.createdate }}</td>
                                <td>{{ x.sra_url }}</td>
                                <td>{{ x.accession }}.sra</td>
                                <td>{{ x.sra_niceFilename }}</td>
                                <td>{{ x.fastq_url }}</td>
                                <td>{{ x.fastq_asperaurl }}</td>
                                <td>{{ x.fastq_filename }}</td>
                                <td>{{ x.fastq_niceFilename }}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
        </div>

        <p ng-show="summaryURL">Query URL = <code ng-bind="summaryURL"></code></p>

    </div><!-- /.container -->

    <hr>
    <div class="container footer text-muted">
        <p>
            SRA-Explorer was written by <a href="http://phil.ewels.co.uk">Phil Ewels</a>.
            Source code is available under a GNU GPLv3 licence at <a href="https://github.com/ewels/sra-explorer">https://github.com/ewels/sra-explorer</a>.
        </p>
        <p>
            Here a lot? It might be worth taking a look at <a href="https://github.com/ewels/sra-explorer#alternatives">some alternative tools</a>..
        </p>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="seqeraPlatformConnectionModal" tabindex="-1" role="dialog" aria-labelledby="seqeraPlatformConnectionModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="seqeraPlatformConnectionModalLabel">Seqera Platform Connection</h4>
          </div>
          <div class="modal-body">
            <p>To connect to the Seqera Platform, please enter your API Base URL and Access Token:</p>
            <div class="form-group">
              <label for="sp_frontend_url">Seqera Platform URL</label>
              <input type="text" class="form-control" ng-model="seqeraplatform.frontend_url" id="sp_frontend_url" placeholder="Platform URL" value="https://tower.nf/" required>
              <p class="help-block small">If using Seqera Cloud, leave as <code>https://tower.nf/</code>. If using a custom Seqera Enterprise installation, enter your base Seqera Platform URL.</p>
            </div>
            <div class="form-group">
              <label for="sp_api_base">API Base URL</label>
              <input type="text" class="form-control" ng-model="seqeraplatform.api_base" id="sp_api_base" placeholder="API Base URL" value="https://api.tower.nf/" required>
              <p class="help-block small">If using Seqera Cloud, leave as <code>https://api.tower.nf/</code>. If using a custom Seqera Enterprise installation, enter your base API route.</p>
            </div>
            <div class="form-group">
              <label for="sp_access_token">Access Token</label>
              <input type="password" class="form-control" ng-model="seqeraplatform.access_token" id="sp_access_token" placeholder="Access Token" required>
              <p class="help-block small">Create an Access Token at <a href="https://tower.nf/tokens" target="_blank">https://tower.nf/tokens</a> (or in your enterprise installation).</p>
            </div>
            <p>
              You may save these details in a browser cookie, so that you do not need to enter them every time.
              This is stored on your device only. <strong>Do not use this feature on a shared computer.</strong>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" ng-click="save_seqera_credentials(seqeraplatform, false)">Close and use this time</button>
            <button type="button" class="btn btn-primary" ng-click="save_seqera_credentials(seqeraplatform, true)">Save in browser cookie</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Core JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular-sanitize.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.10/clipboard.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>

    <!-- SRA-Explorer Code -->
    <script type="text/javascript">
        var app = angular.module("sraExplorerApp", ['ngSanitize']);
        app.controller("searchCtrl", function($scope, $http) {

            $scope.searchText = "";
            $scope.maxResults = 100;
            $scope.retstart = 0;
            $scope.summaryURL = 0;
            $scope.loadingSpinner = 0;
            $scope.sortType = '';
            $scope.results = [];
            $scope.savedResults = [];
            $scope.savedResultsENAaccessions = [];
            $scope.savedResultsENAfastq = [];
            $scope.savedResultsENAfastqYAML = '';
            $scope.showSaved = false;
            $scope.tabChr = "\t";
            $scope.nlChr = "\n";
            $scope.ascp_openssh_location = '$HOME/.aspera/connect/etc/asperaweb_id_dsa.openssh';
            $scope.ascp_append_mv = true;
            $scope.seqeraplatform = {
              'frontend_url': 'https://tower.nf/',
              'api_base': 'https://api.tower.nf/',
              'access_token': '',
              'user_id': '',
              'workspace_id': '',
              'name': '',
              'description': '',
              'credentials_valid': false,
              'orgs': {},
              'workspaces': {},
              'selected_org': '',
              'messages': [],
              'hasError': false
            };

            // Load saved Seqera Platform connection details from cookie (not localstorage)
            if (document.cookie.indexOf('seqeraPlatformFrontendURL') > -1) {
              var frontend_url = document.cookie.split('; ').find(row => row.startsWith('seqeraPlatformFrontendURL=')).split('=')[1];
              if(frontend_url && frontend_url != ''){
                $scope.seqeraplatform.frontend_url = frontend_url;
              }
            }
            if (document.cookie.indexOf('seqeraPlatformAPIBase') > -1) {
              var api_base = document.cookie.split('; ').find(row => row.startsWith('seqeraPlatformAPIBase=')).split('=')[1];
              if(api_base && api_base != ''){
                $scope.seqeraplatform.api_base = api_base;
              }
            }
            if (document.cookie.indexOf('seqeraPlatformAccessToken') > -1) {
              var access_token = document.cookie.split('; ').find(row => row.startsWith('seqeraPlatformAccessToken=')).split('=')[1];
              if(access_token && access_token != ''){
                $scope.seqeraplatform.access_token = access_token;
              }
              console.log("Loaded Seqera Platform credentials from cookie");
            }
            $scope.seqeraplatform.credentials_valid = are_seqera_platform_credentials_valid();


            $scope.search  = function() { searchSRA($scope.searchText); };

            /* Search Function */
            function searchSRA (string) {
                $scope.showSaved = false;
                $scope.loadingSpinner = 1;
                $scope.results = [];
                var searchURL = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=sra&usehistory=y&retmode=json&term='+string;
                $http.get(searchURL).success(function(s_response) {
                    if(s_response.esearchresult.querytranslation){
                        $scope.searchText = s_response.esearchresult.querytranslation;
                    }
                    var webenv = s_response.esearchresult.webenv;
                    var querykey = s_response.esearchresult.querykey;
                    var retmax = $scope.maxResults;
                    var retstart = $scope.retstart;
                    var resultsURL = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=sra&retmode=json&query_key='+querykey+'&WebEnv='+webenv+'&retstart='+retstart+'&retmax='+retmax;
                    $scope.summaryURL = resultsURL;
                    $http.get(resultsURL).success(function(response) {
                        $scope.loadingSpinner = 0;
                        // Parse the stupid embedded XML
                        angular.forEach(response.result, function(value, key) {
                            // Exp XML
                            expXMLraw = '<document>'+value.expxml+'</document>';
                            parser = new DOMParser();
                            expXML = parser.parseFromString(expXMLraw,"text/xml");
                            expJSON = xmlToJson(expXML);
                            if(expJSON.document.Summary){
                                exp = expJSON.document.Summary;
                                value.expxml = exp;
                            }

                            // Runs
                            runsXMLraw = '<document>'+value.runs+'</document>';

                            parser = new DOMParser();
                            runsXML = parser.parseFromString(runsXMLraw,"text/xml");
                            runsJSON = xmlToJson(runsXML);
                            if(runsJSON.document.Run){
                                value.runs = runsJSON.document.Run;
                                // If only one SRR, make it an array
                                if(!Array.isArray(value.runs)){
                                    value.runs = [value.runs];
                                }
                                // Loop through each run result
                                for(var i = 0; i < value.runs.length; i++){
                                    // Add results to scope
                                    try {
                                      var sra_cleanTitle = value.expxml.Title.text.replace(/[^a-z0-9\._\-]/gi, '_').replace(/_+/g, '_');
                                      $scope.results.push({
                                        'title': value.expxml.Title.text,
                                        'accession': value.runs[i].attributes.acc,
                                        'platform': value.expxml.Platform.attributes.instrument_model,
                                        'total_bases': Math.round(value.runs[i].attributes.total_bases / 100000),
                                        'createdate': Date.parse(value.createdate),
                                        'cleanTitle': sra_cleanTitle,
                                        'sra_url': "ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByRun/sra/"+value.runs[i].attributes.acc.substring(0,3)+"/"+value.runs[i].attributes.acc.substring(0,6)+"/"+value.runs[i].attributes.acc+"/"+value.runs[i].attributes.acc+".sra",
                                        'sra_niceFilename': value.runs[i].attributes.acc+'_'+sra_cleanTitle+'.sra'
                                      });
                                    } catch(e){
                                      console.log(e);
                                      console.log({key: value});
                                    }
                                };
                            }



                        });

                        // console.log(response.result);

                    });
                });
            }

            // Toggle row selection checkboxes
            $scope.toggleRow = function($event, obj) {
              $event.stopPropagation();
              obj.selected = !obj.selected;
            }
            $scope.rowClicked = function(obj) {
              obj.selected = !obj.selected;
            };
            $scope.checkAll = function () {
              angular.forEach($scope.filteredResults, function (item) {
                item.selected = $scope.selectAll;
              });
            };
            $scope.$watch('filteredResults', function(items){
              var selectedItems = 0;
              angular.forEach(items, function(item){
                selectedItems += item.selected ? 1 : 0;
              });
              $scope.selectedItems = selectedItems;
            }, true);

            // Save datasets
            $scope.saveDatasets = function() {
              angular.forEach($scope.filteredResults, function(item){
                if(item.selected){
                  var alreadyAdded = false;
                  for (i=0; i<$scope.savedResults.length; i++){
                    if (item['accession'] == $scope.savedResults[i]['accession']){
                      alreadyAdded = true;
                    }
                  }
                  if(!alreadyAdded){
                    $scope.savedResults.push( angular.copy(item) );
                  }
                }
              });
            };

            // Show saved datasets
            $scope.checkoutButton = function(){
              // Clear search results and show saved
              $scope.results = [];
              $scope.summaryURL = 0;
              $scope.loadingSpinner = 0;
              $scope.showSaved = true;
              $scope.fetchFastqENA();
            }

            // Show saved datasets
            $scope.returnToHomeButton = function(){
              // Clear search results and hide results again
              $scope.showSaved = false;
              $scope.results = [];
              $scope.searchText = '';
            }

            // Send saved datasets back to table
            $scope.returnSaved = function() {
              // Clear search results and show saved
              $scope.results = angular.copy( $scope.savedResults );
              $scope.savedResults = [];
              $scope.showSaved = false;
            }

            // Send saved datasets back to table
            $scope.fetchFastqENA = function() {
              if($scope.savedResultsENAaccessions.length < $scope.savedResults.length){
                angular.forEach($scope.savedResults, function(value, key) {
                  if($scope.savedResultsENAaccessions.indexOf(value['accession']) === -1){
                    var ENAsearchURL = 'https://www.ebi.ac.uk/ena/portal/api/filereport?result=read_run&fields=fastq_ftp&format=JSON&accession='+value['accession'];
                    $http.get(ENAsearchURL).success(function(s_response) {
                      for (var i = 0; i < s_response.length; i++) {
                        var ftpFastQ = s_response[i]["fastq_ftp"];
                        if (ftpFastQ != undefined) {
                          // Paired-end FastQ files are given as a single result, need to split by ; character
                          var ftpFastQ_urls = ftpFastQ.split(';');
                          for(var j = 0; j < ftpFastQ_urls.length; j++){
                            // Save the accession now that we have some download filenames, so we know that this worked
                            if($scope.savedResultsENAaccessions.indexOf(value['accession']) === -1){
                              $scope.savedResultsENAaccessions.push(value['accession']);
                            }

                            var fname = ftpFastQ_urls[j].substring(ftpFastQ_urls[j].lastIndexOf('/')+1);
                            $scope.savedResultsENAfastq.push({
                              // Original SRA data
                              'title': value['title'],
                              'accession': value['accession'],
                              'cleanTitle': value['cleanTitle'],
                              'platform': value['platform'],
                              'total_bases': value['total_bases'],
                              'createdate': value['createdate'],
                              'sra_url': value['sra_url'],
                              'sra_niceFilename': value['sra_niceFilename'],
                              // New FastQ fields
                              'fastq_url': 'ftp://'+ftpFastQ_urls[j],
                              'fastq_asperaurl': ftpFastQ_urls[j].replace('ftp.sra.ebi.ac.uk/', 'era-fasp@fasp.sra.ebi.ac.uk:').replace('ftp.ebi.ac.uk/', 'era-fasp@fasp.ebi.ac.uk:'),
                              'fastq_filename': fname,
                              'fastq_niceFilename': value['accession']+'_'+value['cleanTitle']+fname.replace(value['accession'], '')
                            });
                            $scope.savedResultsENAfastqYAML = jsyaml.safeDump($scope.savedResultsENAfastq);
                          }
                        }
                      }
                    });
                  }
                });
              }
            }

            // Customise the ascp openssh location with buttons
            $scope.set_ascp_openssh_location = function(loc){
              if(loc == 'linux'){
                $scope.ascp_openssh_location = '$HOME/.aspera/connect/etc/asperaweb_id_dsa.openssh';
              }
              if(loc == 'osx'){
                $scope.ascp_openssh_location = '$HOME/Applications/Aspera\\ Connect.app/Contents/Resources/asperaweb_id_dsa.openssh';
              }
            }

            // Download contents as a file
            $scope.download_contents = function(target, filename){
                var content = $(target).text();
                var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
                saveAs(blob, filename);
            }

            // Save Seqera Platform API details to a cookie
            $scope.save_seqera_credentials = function(sp, save_cookie) {
              if(save_cookie){
                console.log("Saving Seqera Platform API details to cookie");
                // Expire in 1 month
                var d = new Date();
                d.setTime(d.getTime() + (30*24*60*60*1000));
                var expires = "; expires="+d.toUTCString();
                // Save cookies
                document.cookie = "seqeraPlatformFrontendURL="+sp.frontend_url+expires;
                document.cookie = "seqeraPlatformAPIBase="+sp.api_base+expires;
                document.cookie = "seqeraPlatformAccessToken="+sp.access_token+expires;
              }
              // Set valid state
              $scope.seqeraplatform.credentials_valid = are_seqera_platform_credentials_valid();
              // Hide the modal
              if($scope.seqeraplatform.credentials_valid){
                $('#seqeraPlatformConnectionModal').modal('hide');
              } else {
                alert("Credentials seem invalid");
              }
            }

            function are_seqera_platform_credentials_valid(){
              // Check if we have valid credentials and fetch orgs / workspaces
              if($scope.seqeraplatform.frontend_url && $scope.seqeraplatform.frontend_url != '' && $scope.seqeraplatform.api_base && $scope.seqeraplatform.api_base != '' && $scope.seqeraplatform.access_token && $scope.seqeraplatform.access_token != ''){
                get_seqera_orgs_workspaces();
                return true;
              }
              return false;
            }

            function has_workspace_permissions(roles){
              let valid_roles = ['owner','admin','maintain','launch'];
              for (var i = 0; i < valid_roles.length; i++) {
                if(roles.indexOf(valid_roles[i]) > -1){
                  return true;
                }
              }
              return false;
            }

            function get_seqera_orgs_workspaces(){
              $scope.seqeraplatform.user_id = '';
              $scope.seqeraplatform.orgs = {};
              $scope.seqeraplatform.workspaces = {};
              $scope.seqeraplatform.selected_org = '';
              $scope.seqeraplatform.workspace_id = '';
              // Get the User ID from Seqera API /user-info endpoint
              var api_url_get_user = $scope.seqeraplatform.api_base.replace(/\/+$/, '')+'/user-info';
              var headers = {
                "Content-Type": "application/json",
                "Authorization": "Bearer "+$scope.seqeraplatform.access_token
              };
              $http({
                url: api_url_get_user,
                headers: headers,
                method: "GET"
              }).success(function(sp_response) {
                console.log("Got user:", sp_response);
                $scope.seqeraplatform.user_id = sp_response.user.id;
                // Now get orgs and workspaces
                var api_url_get_orgs_workspaces = $scope.seqeraplatform.api_base.replace(/\/+$/, '')+'/user/'+$scope.seqeraplatform.user_id+'/workspaces';
                $http({
                  url: api_url_get_orgs_workspaces,
                  headers: headers,
                  method: "GET"
                }).success(function(sp_response) {
                  console.log('Got workspaces', sp_response);
                  angular.forEach(sp_response.orgsAndWorkspaces, function(ws, key) {
                    if(ws.workspaceId && has_workspace_permissions(ws.roles)){
                      $scope.seqeraplatform.orgs[ws.orgId] = ws.orgName;
                      if($scope.seqeraplatform.selected_org == ''){
                        $scope.seqeraplatform.selected_org = ws.orgId.toString();
                        $scope.seqeraplatform.workspace_id = ws.workspaceId.toString();
                      }
                      if(!(ws.orgId in $scope.seqeraplatform.workspaces)){
                        $scope.seqeraplatform.workspaces[ws.orgId] = {};
                      }
                      $scope.seqeraplatform.workspaces[ws.orgId][ws.workspaceId] = ws.workspaceName;
                    }
                  });
                });
              }, function errorCallback(sp_response) {
                console.log("Error fetching Seqera Platform orgs", sp_response);
                $scope.seqeraplatform.credentials_valid = false;
              });
            }

            $scope.update_seqera_org = function(){
              $scope.seqeraplatform.workspace_id = Object.keys($scope.seqeraplatform.workspaces[$scope.seqeraplatform.selected_org])[0].toString();
              $scope.seqeraplatform.messages = [];
              $scope.seqeraplatform.hasError = false;
            }

            // Send metadata to Seqera Platform
            $scope.save_seqeraplatform = function(sp) {
              $scope.seqeraplatform.messages = [];
              $scope.seqeraplatform.hasError = false;
              // First, create the new dataset
              var api_url_create_dataset = sp.api_base.replace(/\/+$/, '')+'/workspaces/'+sp.workspace_id+'/datasets';
              var create_dataset_formData = {'name': sp.name, 'description': sp.description};
              var headers = {
                "Content-Type": "application/json",
                "Authorization": "Bearer "+sp.access_token
              };
              $http.post(
                api_url_create_dataset,
                JSON.stringify(create_dataset_formData),
                {"headers": headers, "withCredentials": true}
              ).then(function successCallback(sp_response) {
                console.log(sp_response);
                if(!("dataset" in sp_response.data) && "message" in sp_response.data){
                  $scope.seqeraplatform.messages.push('Error creating dataset: '+sp_response.data.message);
                  return;
                }
                // Build FE URL to published dataset
                let org_name = sp.orgs[sp.selected_org];
                let ws_name = sp.workspaces[sp.selected_org][sp.workspace_id];
                let dataset_url = sp.frontend_url.replace(/\/+$/, '')+'/orgs/'+org_name+'/workspaces/'+ws_name+'/datasets/'+sp_response.data.dataset.id;
                $scope.seqeraplatform.messages.push('<span class="glyphicon glyphicon-ok"></span> Created dataset: <code>'+sp_response.data.dataset.id)+'</code> (<a href="'+dataset_url+'" target="_blank">View on Seqera Platform <span class="glyphicon glyphicon-new-window"></span></a>)';

                // Now upload the data to the created dataset
                var api_url_upload_dataset = api_url_create_dataset+'/'+sp_response.data.dataset.id+'/upload?header=true';
                headers["Content-Type"] = undefined; // needed for multipart form data
                var upload_dataset_formData = new FormData();
                var dataset_content = $("#fullTSV_content").text();
                var dataset_blob = new Blob([dataset_content], { type: "text/tab-separated-values" });
                upload_dataset_formData.append('file', dataset_blob, 'sra_explorer_metadata.tsv');
                $http({
                    url: api_url_upload_dataset,
                    headers: headers,
                    data: upload_dataset_formData,
                    method: "POST"
                }).then(function successCallback(sp_response) {
                    console.log(sp_response);
                    $scope.seqeraplatform.messages.push('<span class="glyphicon glyphicon-ok"></span> Successfully uploaded metadata');
                }, function errorCallback(sp_response) {
                    $scope.seqeraplatform.hasError = true;
                    $scope.seqeraplatform.messages.push('Error when uploading metadata (Error '+sp_response.status+' - '+sp_response.statusText+')');
                    $scope.seqeraplatform.messages.push('<pre><code>'+JSON.stringify(sp_response.data)+'</code></pre>');
                });
              }, function errorCallback(sp_response) {
                $scope.seqeraplatform.hasError = true;
                $scope.seqeraplatform.messages.push('Error when creating dataset (<code>'+sp_response.status+' - '+sp_response.statusText+'</code>)');
                $scope.seqeraplatform.messages.push('<pre><code>'+JSON.stringify(sp_response.data)+'</code></pre>');
              });
            };
        });

        // Stolen frmo http://davidwalsh.name/convert-xml-json
        // Changes XML to JSON
        function xmlToJson(xml) {

            // Create the return object
            var obj = {};

            if (xml.nodeType == 1) { // element
                // do attributes
                if (xml.attributes.length > 0) {
                obj["attributes"] = {};
                    for (var j = 0; j < xml.attributes.length; j++) {
                        var attribute = xml.attributes.item(j);
                        obj["attributes"][attribute.nodeName] = attribute.value;
                    }
                }
            } else if (xml.nodeType == 3) { // text
                obj = xml.nodeValue;
            }

            // do children
            if (xml.hasChildNodes()) {
                for(var i = 0; i < xml.childNodes.length; i++) {
                    var item = xml.childNodes.item(i);
                    var nodeName = item.nodeName.replace('#','');
                    if (typeof(obj[nodeName]) == "undefined") {
                        obj[nodeName] = xmlToJson(item);
                    } else {
                        if (typeof(obj[nodeName].push) == "undefined") {
                            var old = obj[nodeName];
                            obj[nodeName] = [];
                            obj[nodeName].push(old);
                        }
                        obj[nodeName].push(xmlToJson(item));
                    }
                }
            }
            return obj;
        };

        // Activate the copy buttons
        new Clipboard('.btn-copy');

    </script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-51481908-2', 'auto');
        ga('send', 'pageview');
    </script>
</body>
</html>
